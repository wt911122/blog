<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.fe884e9f3083832f1ef9.css">code[class*=language-],pre[class*=language-]{color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#073642}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{color:#657b83;background:#eee8d5}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.delay-1,.delay-1:after,.delay-1:before{-webkit-animation-delay:.3s;animation-delay:.3s}.delay-2,.delay-2:after,.delay-2:before{-webkit-animation-delay:.6s;animation-delay:.6s}.delay-3,.delay-3:after,.delay-3:before{-webkit-animation-delay:.9s;animation-delay:.9s}.delay-4,.delay-4:after,.delay-4:before{-webkit-animation-delay:1.2s;animation-delay:1.2s}.delay-5,.delay-5:after,.delay-5:before{-webkit-animation-delay:1.5s;animation-delay:1.5s}.delay-6,.delay-6:after,.delay-6:before{-webkit-animation-delay:1.8s;animation-delay:1.8s}.delay-7,.delay-7:after,.delay-7:before{-webkit-animation-delay:2.1s;animation-delay:2.1s}.delay-8,.delay-8:after,.delay-8:before{-webkit-animation-delay:2.4s;animation-delay:2.4s}.delay-9,.delay-9:after,.delay-9:before{-webkit-animation-delay:2.7s;animation-delay:2.7s}.delay-10,.delay-10:after,.delay-10:before{-webkit-animation-delay:3s;animation-delay:3s}.delay-11,.delay-11:after,.delay-11:before{-webkit-animation-delay:3.3s;animation-delay:3.3s}.delay-12,.delay-12:after,.delay-12:before{-webkit-animation-delay:3.6s;animation-delay:3.6s}.letter{font-family:Comic Sans,Comic Sans MS,cursive;font-size:36px;display:inline-block;width:1.5em;height:1.5em;position:relative;line-height:1.5em;text-align:center;padding:0;-webkit-animation-name:joggle;animation-name:joggle;-webkit-animation-duration:.5s;animation-duration:.5s;-webkit-animation-timing-function:ease-in;animation-timing-function:ease-in;border-color:transparent}.letter:after{width:1.5em;height:1.5em;left:0;top:0;border-radius:100%;-webkit-animation-name:expand;animation-name:expand;-webkit-animation-timing-function:ease-out;animation-timing-function:ease-out;border:2px solid transparent}.letter:after,.letter:before{content:" ";display:block;position:absolute;-webkit-animation-duration:.25s;animation-duration:.25s}.letter:before{width:.9em;height:.9em;left:.3em;top:.3em;background:#fff;border-radius:100%;-webkit-transform:scale(0);transform:scale(0);-webkit-animation-name:shrink;animation-name:shrink;-webkit-animation-timing-function:ease-out;animation-timing-function:ease-out}@-webkit-keyframes expand{0%{-webkit-transform:scale(.8);transform:scale(.8);border-color:#fff}to{-webkit-transform:scale(1);transform:scale(1);border-color:#fff}}@keyframes expand{0%{-webkit-transform:scale(.8);transform:scale(.8);border-color:#fff}to{-webkit-transform:scale(1);transform:scale(1);border-color:#fff}}@-webkit-keyframes shrink{0%{-webkit-transform:scale(1);transform:scale(1)}to{-webkit-transform:scale(0);transform:scale(0)}}@keyframes shrink{0%{-webkit-transform:scale(1);transform:scale(1)}to{-webkit-transform:scale(0);transform:scale(0)}}@-webkit-keyframes joggle{0%{-webkit-transform:rotate(24deg);transform:rotate(24deg)}65%{-webkit-transform:rotate(-12deg);transform:rotate(-12deg)}92%{-webkit-transform:rotate(6deg);transform:rotate(6deg)}to{-webkit-transform:rotate(0);transform:rotate(0)}}@keyframes joggle{0%{-webkit-transform:rotate(24deg);transform:rotate(24deg)}65%{-webkit-transform:rotate(-12deg);transform:rotate(-12deg)}92%{-webkit-transform:rotate(6deg);transform:rotate(6deg)}to{-webkit-transform:rotate(0);transform:rotate(0)}}html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em georgia,serif;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}dl{list-style:none}:root{--container-max-with-1366:1024px;--container-max-with-1920:1680px}.container{position:relative;max-width:var(--container-max-with-1366);margin:0 auto;display:-webkit-flex;display:flex;-webkit-flex-direction:row;flex-direction:row}.sideblock{width:280px}.maincontent{-webkit-flex:1 1;flex:1 1;margin-left:20px;width:100%}@media (min-width:1720px){.container{max-width:var(--container-max-with-1920)}}.brick{width:100%;transition:.6s cubic-bezier(.01,1.69,.99,.94);display:block;margin:auto;background:#fff;border:1px solid transparent;border-radius:0;padding:8.87px;box-shadow:0 2px 12px 3px hsla(0,0%,80%,.58)}.brick+.brick{margin-top:20px}.brick h1{transition:all .6s;text-align:center}.brick:hover h1{letter-spacing:2px}.responsive-image{width:100%;height:auto}.side-menu{font-size:.8em}.side-menu:before{content:" ";display:inline-block;width:1em;height:1em;background-size:1em auto;background-position:50%;background-repeat:no-repeat;vertical-align:baeline;margin-right:.5em}.github-side:before{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAfCAQAAAAsXwcHAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QAAKqNIzIAAAAJcEhZcwAAAyAAAAMgADzko2IAAAI8SURBVDjLxZTLaxNBGMB/1iRtY5qFauKjEh8Jovg4pCo1SkF8FEEqPfRSRA9C0YviX6GI/4KCiIKoFKQeVLwoSIP2YB5WUTABD4mPpoa0aUvS6WEns7vp7qYn/eaws9/jN/N9M9/A/5Y1jnqNXUQIASXyfGWapdUCOullkH52sw4PUKfKNyZ4xlsqrXe0nwf8RdiMWcZI0OYW7uESOdvgxihylXbn8GuUXcP1fdygwx5wgTKCGkkmmV8RuEiGJAsIqlw3EjGKGOcp24FfDJDjFFfwM0UFgZcYPu4xToAXRIE/jPDSunoH9+VKeSIAaGhqHT+a/L6RXq/ptgKOq+x/EHMscpiMSmhEVzXWOEuXnH1mxhEwx5SceRnEYxg0JiS5ypDrPTlKSXrmzDvtZVqpt7kCgryTnvOcMVLQ6JQOBUqugAo5OWvXi60DNuKT6i6FshefqfptBmCWulRuoscVEG4+Ix0wQ03+d5NwBRxmq5wJc2fu5Lu6slnijuExPii/MkcMg5cxBII6WYqkuMhmVZWGR4hhddgCwXvWmx0us4RA8JAhPlLjC885oax7eUyGOUtz3bRuLkJaGU7ziSppDihrkDtNvfmTvub8RllEICiQoIc+tljenji/LYBbrG0GBHkkjZMMEOWg5eWJkDeFJ+3v6w7VrBWKJNngAMjT73RMUcapS7eUAyDDSbeLEuK2bKw0oRWABZ6whxbi5Rh3KZAibAFkecV5gq3CdfGwj3P4TZoAhwisLvhfyzLwaQz0+rokowAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxNS0xMC0yNVQwOTo0MjozMSswODowMCQHU3cAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTUtMTAtMjVUMDk6NDI6MzErMDg6MDBVWuvLAAAATnRFWHRzb2Z0d2FyZQBJbWFnZU1hZ2ljayA2LjguOC0xMCBRMTYgeDg2XzY0IDIwMTUtMDctMTkgaHR0cDovL3d3dy5pbWFnZW1hZ2ljay5vcmcFDJw1AAAAGHRFWHRUaHVtYjo6RG9jdW1lbnQ6OlBhZ2VzADGn/7svAAAAGHRFWHRUaHVtYjo6SW1hZ2U6OkhlaWdodAA0NDAdNqzfAAAAF3RFWHRUaHVtYjo6SW1hZ2U6OldpZHRoADQ1Mw7VnHkAAAAZdEVYdFRodW1iOjpNaW1ldHlwZQBpbWFnZS9wbmc/slZOAAAAF3RFWHRUaHVtYjo6TVRpbWUAMTQ0NTczNzM1MTXPfuMAAAATdEVYdFRodW1iOjpTaXplADguNTJLQkKDEIKZAAAAWnRFWHRUaHVtYjo6VVJJAGZpbGU6Ly8vaG9tZS93d3dyb290L3d3dy5lYXN5aWNvbi5uZXQvY2RuLWltZy5lYXN5aWNvbi5jbi9zcmMvMTE4ODcvMTE4ODc4My5wbmfGwdNUAAAAAElFTkSuQmCC)}.comp-side:before{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAQAAADZc7J/AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAHdElNRQfjAQkCNwZmjHTZAAADKklEQVRIx33UW2gcZRjG8d/sIQeNNY2hplTaWBBFg8YLSZHEUKFQLQgmaiqIVRBRMZ4ubC0IFiXoRaAqiiJF29JawVC90KQKBqMShFIiFBHRHqzYhKZRo7XZZJPxYiezs5vDuzDz7fvO/Od5n+8QAM3wuF7VihF627NmRiwXQfP8KONTd5ZVT2h1tjBcCpNugHW6PGyjy8qqWautMu5vGowuqWCz19y4jMof7DCwlIag+VYHNMr7ybhgQX2Va2Sc1GFkcURGt0YX7LLX5CKAFR7yoqttW8qEoPm8On22yi/RQNYhHY7ZZKK0UCCm1GFMHlUa1EcqUuo1qMSMUdSrQVZ19EtFUy9V0IEabxjylfvBgwYNed2lUZU5G3xsQL9+R/SqLSAysaI6d7gKtzmIDZpQrceF+Imt7orHtzhsiOZIQUFFmGgwjK5Bop5N1Cu9YofVSQX/OulKc86Ac3ICv/gn8VIqMQ60aXO7J4uA87ZZK+9HsNsRaadKnD/qsNn43zo32+T5IiCtTYtpBx3Fte6RNexQ/Epgj72JFlf6wBYdRUCDl6xH2lE84AlsNuiPhIbkWhl3GiuLfWUiPyriiaWixDgq48WVmX8mlaAX+NOJWciZSVj4tH5duM4B71tjTsk6GLNTq4s+BPv8p9KQsbjnSndr97uPtLvXjPfKAXnfOyvvBPjZYRmnEq6H8pG+HGblCy0UAVfYp8Wcl/XgGdsFhnU6H3mS0+uYPnzuBVOOF9ovAmo0qsBasEol1quJAIQm/GoS087EjiVMDEtOgyC6hnG1yi7v6MYW++1xU7kHEwa0y/kGfKdVhcH4+wSqUYMVAhWyBXhyL3SrlTcO9uuX8Zep+PVpA9K+xLDP5Jwu94Apoy6JPOCciyWLaNardpvCiE6h6TLAcU3UeVObEIGvPeXP45qKiDBG5orJTMlXrtehKhp3ete3SmO9R10u9IkvFgACSJccKmnlx/QjtoMWxyKvomkMuSG6J2Jhtja616uezxcUtHtLILQmsfuyntMlEGqPcPfZGNXq9Jgs5IPm6bItu3j8ptVOjy3Iz6T0JTbM8jG7SKbvf1Jx5+ByeuJKAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE5LTAxLTA5VDAyOjU1OjA2KzA4OjAwj81cEQAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxOS0wMS0wOVQwMjo1NTowNiswODowMP6Q5K0AAABDdEVYdHNvZnR3YXJlAC91c3IvbG9jYWwvaW1hZ2VtYWdpY2svc2hhcmUvZG9jL0ltYWdlTWFnaWNrLTcvL2luZGV4Lmh0bWy9tXkKAAAAGHRFWHRUaHVtYjo6RG9jdW1lbnQ6OlBhZ2VzADGn/7svAAAAGHRFWHRUaHVtYjo6SW1hZ2U6OkhlaWdodAA1MTKPjVOBAAAAF3RFWHRUaHVtYjo6SW1hZ2U6OldpZHRoADUxMhx8A9wAAAAZdEVYdFRodW1iOjpNaW1ldHlwZQBpbWFnZS9wbmc/slZOAAAAF3RFWHRUaHVtYjo6TVRpbWUAMTU0Njk3MzcwNreu6eAAAAARdEVYdFRodW1iOjpTaXplADg3MzRCaCntVQAAAGJ0RVh0VGh1bWI6OlVSSQBmaWxlOi8vL2hvbWUvd3d3cm9vdC9uZXdzaXRlL3d3dy5lYXN5aWNvbi5uZXQvY2RuLWltZy5lYXN5aWNvbi5jbi9maWxlcy8xMTMvMTEzMTc2OC5wbmf3tk0kAAAAAElFTkSuQmCC)}.author-meta{font-size:1.4em;font-family:Impact,fantasy}a{color:#20b2aa}a:active{color:#6495ed}.gitment-container{font-family:sans-serif;font-size:14px;line-height:1.5;color:#333;word-wrap:break-word}.gitment-container *{box-sizing:border-box}.gitment-container :disabled{cursor:not-allowed}.gitment-container a,.gitment-container a:visited{cursor:pointer;text-decoration:none}.gitment-container a:hover{text-decoration:underline}.gitment-container .gitment-hidden{display:none}.gitment-container .gitment-spinner-icon{fill:#333;-webkit-animation:gitment-spin 1s steps(12) infinite;animation:gitment-spin 1s steps(12) infinite}@-webkit-keyframes gitment-spin{to{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}@keyframes gitment-spin{to{-webkit-transform:rotate(1turn);transform:rotate(1turn)}}.gitment-header-container,.gitment-root-container{margin:19px 0}.gitment-comment-like-btn,.gitment-header-like-btn{cursor:pointer}.gitment-comment-like-btn{float:right}.gitment-comment-like-btn.liked{color:#f44336}.gitment-header-like-btn svg{vertical-align:middle;height:30px}.gitment-comment-like-btn svg{vertical-align:middle;height:20px}.gitment-comment-like-btn.liked svg,.gitment-header-like-btn.liked svg{fill:#f44336}a.gitment-header-issue-link,a.gitment-header-issue-link:visited{float:right;line-height:30px;color:#666}a.gitment-header-issue-link:hover{color:#666}.gitment-comments-empty,.gitment-comments-error,.gitment-comments-loading{text-align:center;margin:50px 0}.gitment-comments-list{list-style:none;padding-left:0;margin:0 0 38px}.gitment-comment,.gitment-editor-container{position:relative;min-height:60px;padding-left:60px;margin:19px 0}.gitment-comment-avatar,.gitment-editor-avatar{float:left;margin-left:-60px}.gitment-comment-avatar,.gitment-comment-avatar-img,.gitment-editor-avatar-img,.gitment-editor-avatar svg{width:44px;height:44px;border-radius:3px}.gitment-editor-avatar .gitment-github-icon{fill:#fff;background-color:#333}.gitment-comment-main,.gitment-editor-main{position:relative;border:1px solid #cfd8dc;border-radius:0}.gitment-comment-main:after,.gitment-comment-main:before,.gitment-editor-main:after,.gitment-editor-main:before{position:absolute;top:11px;left:-16px;display:block;width:0;height:0;pointer-events:none;content:"";border-color:transparent;border-style:solid solid outset}.gitment-comment-main:before,.gitment-editor-main:before{border-width:8px;border-right-color:#cfd8dc}.gitment-comment-main:after,.gitment-editor-main:after{margin-top:1px;margin-left:2px;border-width:7px;border-right-color:#fff}.gitment-comment-header{margin:12px 15px;color:#666;background-color:#fff;border-radius:3px}.gitment-editor-header{padding:0;margin:0;border-bottom:1px solid #cfd8dc}a.gitment-comment-name,a.gitment-comment-name:visited{font-weight:600;color:#666}.gitment-editor-tabs{margin-bottom:-1px;margin-left:-1px}.gitment-editor-tab{display:inline-block;padding:11px 12px;font-size:14px;line-height:20px;color:#666;text-decoration:none;background-color:transparent;border-color:transparent;border-style:solid;border-width:0 1px;border-radius:0;white-space:nowrap;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;outline:none}.gitment-editor-tab.gitment-selected{color:#333;background-color:#fff;border-color:#cfd8dc}.gitment-editor-login{float:right;margin-top:-30px;margin-right:15px}a.gitment-editor-login-link,a.gitment-editor-login-link:visited,a.gitment-footer-project-link,a.gitment-footer-project-link:visited{color:#2196f3}a.gitment-editor-logout-link,a.gitment-editor-logout-link:visited{color:#666}a.gitment-editor-logout-link:hover{color:#2196f3;text-decoration:none}.gitment-comment-body{position:relative;margin:12px 15px;overflow:hidden;border-radius:3px}.gitment-comment-body-folded{cursor:pointer}.gitment-comment-body-folded:before{content:"";top:0;bottom:50px;background:linear-gradient(180deg,hsla(0,0%,100%,0),hsla(0,0%,100%,.9))}.gitment-comment-body-folded:after,.gitment-comment-body-folded:before{display:block!important;position:absolute;width:100%;left:0;pointer-events:none}.gitment-comment-body-folded:after{content:"Click to Expand"!important;text-align:center;color:#666;height:50px;line-height:50px;bottom:0;background:hsla(0,0%,100%,.9)}.gitment-editor-body{margin:0}.gitment-comment-body>:first-child,.gitment-editor-preview>:first-child{margin-top:0!important}.gitment-comment-body>:last-child,.gitment-editor-preview>:last-child{margin-bottom:0!important}.gitment-editor-body textarea{display:block;width:100%;min-height:150px;max-height:500px;padding:16px;resize:vertical;max-width:100%;margin:0;font-size:14px;line-height:1.6;background-color:#fff;color:#333;vertical-align:middle;border:none;border-radius:0;outline:none;box-shadow:none;overflow:visible}.gitment-editor-body textarea:focus{background-color:#fff}.gitment-editor-preview{min-height:150px;padding:16px;background-color:transparent;width:100%;font-size:14px;line-height:1.5;word-wrap:break-word}.gitment-editor-footer{padding:0;margin-top:10px}.gitment-editor-footer:after{display:table;clear:both;content:""}a.gitment-editor-footer-tip{display:inline-block;padding-top:10px;font-size:12px;color:#666}a.gitment-editor-footer-tip:hover{color:#2196f3;text-decoration:none}.gitment-comments-pagination{list-style:none;text-align:right;border-radius:0;margin:-19px 0 19px}.gitment-comments-page-item{display:inline-block;cursor:pointer;border:1px solid #cfd8dc;margin-left:-1px;padding:.25rem .5rem}.gitment-comments-page-item.gitment-selected,.gitment-comments-page-item:hover{background-color:#f5f5f5}.gitment-comments-init-btn,.gitment-editor-submit{color:#fff;background-color:#00bcd4;position:relative;display:inline-block;padding:7px 13px;font-size:14px;font-weight:600;line-height:20px;white-space:nowrap;vertical-align:middle;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;background-size:110% 110%;border:none;-webkit-appearance:none;-moz-appearance:none;appearance:none}.gitment-comments-init-btn:hover,.gitment-editor-submit:hover{background-color:#00acc1}.gitment-comments-init-btn:disabled,.gitment-editor-submit:disabled{color:hsla(0,0%,100%,.75);background-color:#4dd0e1;box-shadow:none}.gitment-editor-submit{float:right}.gitment-footer-container{margin-top:30px;margin-bottom:20px;text-align:right;font-size:12px}.gitment-markdown{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#333;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;font-size:16px;line-height:1.5;word-wrap:break-word}.gitment-markdown .pl-c{color:#969896}.gitment-markdown .pl-c1,.gitment-markdown .pl-s .pl-v{color:#0086b3}.gitment-markdown .pl-e,.gitment-markdown .pl-en{color:#795da3}.gitment-markdown .pl-s .pl-s1,.gitment-markdown .pl-smi{color:#333}.gitment-markdown .pl-ent{color:#63a35c}.gitment-markdown .pl-k{color:#a71d5d}.gitment-markdown .pl-pds,.gitment-markdown .pl-s,.gitment-markdown .pl-s .pl-pse .pl-s1,.gitment-markdown .pl-sr,.gitment-markdown .pl-sr .pl-cce,.gitment-markdown .pl-sr .pl-sra,.gitment-markdown .pl-sr .pl-sre{color:#183691}.gitment-markdown .pl-smw,.gitment-markdown .pl-v{color:#ed6a43}.gitment-markdown .pl-bu{color:#b52a1d}.gitment-markdown .pl-c2,.gitment-markdown .pl-ii{color:#f8f8f8;background-color:#b52a1d}.gitment-markdown .pl-c2:before{content:"^M"}.gitment-markdown .pl-sr .pl-cce{font-weight:700;color:#63a35c}.gitment-markdown .pl-ml{color:#693a17}.gitment-markdown .pl-mh,.gitment-markdown .pl-mh .pl-en,.gitment-markdown .pl-ms{font-weight:700;color:#1d3e81}.gitment-markdown .pl-mq{color:teal}.gitment-markdown .pl-mi{font-style:italic;color:#333}.gitment-markdown .pl-mb{font-weight:700;color:#333}.gitment-markdown .pl-md{color:#bd2c00;background-color:#ffecec}.gitment-markdown .pl-mi1{color:#55a532;background-color:#eaffea}.gitment-markdown .pl-mc{color:#ef9700;background-color:#ffe3b4}.gitment-markdown .pl-mi2{color:#d8d8d8;background-color:grey}.gitment-markdown .pl-mdr{font-weight:700;color:#795da3}.gitment-markdown .pl-mo{color:#1d3e81}.gitment-markdown .pl-ba{color:#595e62}.gitment-markdown .pl-sg{color:silver}.gitment-markdown .pl-corl{text-decoration:underline;color:#183691}.gitment-markdown .octicon{display:inline-block;vertical-align:text-top;fill:currentColor}.gitment-markdown a{background-color:transparent;-webkit-text-decoration-skip:objects}.gitment-markdown a:active,.gitment-markdown a:hover{outline-width:0}.gitment-markdown strong{font-weight:inherit;font-weight:bolder}.gitment-markdown h1{margin:.67em 0}.gitment-markdown img{border-style:none}.gitment-markdown svg:not(:root){overflow:hidden}.gitment-markdown code,.gitment-markdown kbd,.gitment-markdown pre{font-family:monospace,monospace;font-size:1em}.gitment-markdown hr{box-sizing:content-box;overflow:visible}.gitment-markdown input{font:inherit;margin:0;overflow:visible}.gitment-markdown [type=checkbox]{box-sizing:border-box;padding:0}.gitment-markdown *{box-sizing:border-box}.gitment-markdown input{font-family:inherit;font-size:inherit;line-height:inherit}.gitment-markdown a{color:#0366d6;text-decoration:none}.gitment-markdown a:hover{text-decoration:underline}.gitment-markdown strong{font-weight:600}.gitment-markdown hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.gitment-markdown hr:before{display:table;content:""}.gitment-markdown hr:after{display:table;clear:both;content:""}.gitment-markdown table{border-spacing:0;border-collapse:collapse}.gitment-markdown td,.gitment-markdown th{padding:0}.gitment-markdown h1,.gitment-markdown h2,.gitment-markdown h3,.gitment-markdown h4,.gitment-markdown h5,.gitment-markdown h6{margin-top:0;margin-bottom:0}.gitment-markdown h1{font-size:32px;font-weight:600}.gitment-markdown h2{font-size:24px;font-weight:600}.gitment-markdown h3{font-size:20px;font-weight:600}.gitment-markdown h4{font-size:16px;font-weight:600}.gitment-markdown h5{font-size:14px;font-weight:600}.gitment-markdown h6{font-size:12px;font-weight:600}.gitment-markdown p{margin-top:0;margin-bottom:10px}.gitment-markdown blockquote{margin:0}.gitment-markdown ol,.gitment-markdown ul{padding-left:0;margin-top:0;margin-bottom:0}.gitment-markdown ol ol,.gitment-markdown ul ol{list-style-type:lower-roman}.gitment-markdown ol ol ol,.gitment-markdown ol ul ol,.gitment-markdown ul ol ol,.gitment-markdown ul ul ol{list-style-type:lower-alpha}.gitment-markdown dd{margin-left:0}.gitment-markdown code{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;font-size:12px}.gitment-markdown pre{margin-top:0;margin-bottom:0;font:12px SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace}.gitment-markdown .octicon{vertical-align:text-bottom}.gitment-markdown .pl-0{padding-left:0!important}.gitment-markdown .pl-1{padding-left:4px!important}.gitment-markdown .pl-2{padding-left:8px!important}.gitment-markdown .pl-3{padding-left:16px!important}.gitment-markdown .pl-4{padding-left:24px!important}.gitment-markdown .pl-5{padding-left:32px!important}.gitment-markdown .pl-6{padding-left:40px!important}.gitment-markdown:after,.gitment-markdown:before{display:table;content:""}.gitment-markdown:after{clear:both}.gitment-markdown>:first-child{margin-top:0!important}.gitment-markdown>:last-child{margin-bottom:0!important}.gitment-markdown a:not([href]){color:inherit;text-decoration:none}.gitment-markdown .anchor{float:left;padding-right:4px;margin-left:-20px;line-height:1}.gitment-markdown .anchor:focus{outline:none}.gitment-markdown blockquote,.gitment-markdown dl,.gitment-markdown ol,.gitment-markdown p,.gitment-markdown pre,.gitment-markdown table,.gitment-markdown ul{margin-top:0;margin-bottom:16px}.gitment-markdown hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.gitment-markdown blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.gitment-markdown blockquote>:first-child{margin-top:0}.gitment-markdown blockquote>:last-child{margin-bottom:0}.gitment-markdown kbd{font-size:11px;background-color:#fafbfc}.gitment-markdown h1,.gitment-markdown h2,.gitment-markdown h3,.gitment-markdown h4,.gitment-markdown h5,.gitment-markdown h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.gitment-markdown h1 .octicon-link,.gitment-markdown h2 .octicon-link,.gitment-markdown h3 .octicon-link,.gitment-markdown h4 .octicon-link,.gitment-markdown h5 .octicon-link,.gitment-markdown h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.gitment-markdown h1:hover .anchor,.gitment-markdown h2:hover .anchor,.gitment-markdown h3:hover .anchor,.gitment-markdown h4:hover .anchor,.gitment-markdown h5:hover .anchor,.gitment-markdown h6:hover .anchor{text-decoration:none}.gitment-markdown h1:hover .anchor .octicon-link,.gitment-markdown h2:hover .anchor .octicon-link,.gitment-markdown h3:hover .anchor .octicon-link,.gitment-markdown h4:hover .anchor .octicon-link,.gitment-markdown h5:hover .anchor .octicon-link,.gitment-markdown h6:hover .anchor .octicon-link{visibility:visible}.gitment-markdown h1{font-size:2em}.gitment-markdown h1,.gitment-markdown h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.gitment-markdown h2{font-size:1.5em}.gitment-markdown h3{font-size:1.25em}.gitment-markdown h4{font-size:1em}.gitment-markdown h5{font-size:.875em}.gitment-markdown h6{font-size:.85em;color:#6a737d}.gitment-markdown ol,.gitment-markdown ul{padding-left:2em}.gitment-markdown ol ol,.gitment-markdown ol ul,.gitment-markdown ul ol,.gitment-markdown ul ul{margin-top:0;margin-bottom:0}.gitment-markdown li>p{margin-top:16px}.gitment-markdown li+li{margin-top:.25em}.gitment-markdown dl{padding:0}.gitment-markdown dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.gitment-markdown dl dd{padding:0 16px;margin-bottom:16px}.gitment-markdown table{display:block;width:100%;overflow:auto}.gitment-markdown table th{font-weight:600}.gitment-markdown table td,.gitment-markdown table th{padding:6px 13px;border:1px solid #dfe2e5}.gitment-markdown table tr{background-color:#fff;border-top:1px solid #c6cbd1}.gitment-markdown table tr:nth-child(2n){background-color:#f5f5f5}.gitment-markdown img{max-width:100%;box-sizing:content-box;background-color:#fff}.gitment-markdown code{padding:.2em 0;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:0}.gitment-markdown code:after,.gitment-markdown code:before{letter-spacing:-.2em;content:"\A0"}.gitment-markdown pre{word-wrap:normal}.gitment-markdown pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.gitment-markdown .highlight{margin-bottom:16px}.gitment-markdown .highlight pre{margin-bottom:0;word-break:normal}.gitment-markdown .highlight pre,.gitment-markdown pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f5f5f5;border-radius:0}.gitment-markdown pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.gitment-markdown pre code:after,.gitment-markdown pre code:before{content:normal}.gitment-markdown .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.gitment-markdown kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fcfcfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:0;box-shadow:inset 0 -1px 0 #959da5}.gitment-markdown :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.gitment-markdown .task-list-item{list-style-type:none}.gitment-markdown .task-list-item+.task-list-item{margin-top:3px}.gitment-markdown .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}.gitment-markdown hr{border-bottom-color:#eee}</style><meta name="generator" content="Gatsby 2.1.24"/><title data-react-helmet="true"></title><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png"/><link as="script" rel="preload" href="/app-10d8601ec8ddaba350d4.js"/><link as="script" rel="preload" href="/component---src-template-blog-template-js-33d564d6a33c6a5966d5.js"/><link as="script" rel="preload" href="/styles-a37a2e6ccdfe373f027f.js"/><link as="script" rel="preload" href="/webpack-runtime-4b53265e0c6f6db20aa5.js"/><link as="fetch" rel="preload" href="/static/d/964/path---webpack-note-0-d-1-504-2l9gdkNmgb2VUQV7d4FzHJIydiY.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><header style="background:url(/static/bg-3ed1e20ae9f21b4acf72837089256d37.png) 50% 30%/100% auto;margin-bottom:1.45rem"><div style="padding:1.45rem 1.0875rem" class="container"><div><h1 style="margin:0"><a style="font-family:Andale Mono, monospace;color:#000;text-decoration:none;text-shadow:#FFF 1px 1px 10px, #FFF -1px -1px 10px" href="/"><div class="letter delay-1" style="font-size:36px;font-family:Andale Mono, monospace">W</div><div class="letter delay-1" style="font-size:36px;font-family:Andale Mono, monospace">e</div><div class="letter delay-1" style="font-size:36px;font-family:Andale Mono, monospace">b</div><div class="letter delay-1" style="font-size:36px;font-family:Andale Mono, monospace">p</div><div class="letter delay-1" style="font-size:36px;font-family:Andale Mono, monospace">a</div><div class="letter delay-1" style="font-size:36px;font-family:Andale Mono, monospace">c</div><div class="letter delay-1" style="font-size:36px;font-family:Andale Mono, monospace">k</div><br/><div class="letter delay-3" style="font-size:36px;font-family:Andale Mono, monospace">(</div><div class="letter delay-3" style="font-size:36px;font-family:Andale Mono, monospace">v</div><div class="letter delay-3" style="font-size:36px;font-family:Andale Mono, monospace">4</div><div class="letter delay-3" style="font-size:36px;font-family:Andale Mono, monospace">.</div><div class="letter delay-3" style="font-size:36px;font-family:Andale Mono, monospace">3</div><div class="letter delay-3" style="font-size:36px;font-family:Andale Mono, monospace">1</div><div class="letter delay-3" style="font-size:36px;font-family:Andale Mono, monospace">.</div><div class="letter delay-3" style="font-size:36px;font-family:Andale Mono, monospace">0</div><div class="letter delay-3" style="font-size:36px;font-family:Andale Mono, monospace">)</div><br/><div class="letter delay-5" style="font-size:36px;font-family:Andale Mono, monospace">源</div><div class="letter delay-5" style="font-size:36px;font-family:Andale Mono, monospace">码</div><div class="letter delay-5" style="font-size:36px;font-family:Andale Mono, monospace">阅</div><div class="letter delay-5" style="font-size:36px;font-family:Andale Mono, monospace">读</div><div class="letter delay-5" style="font-size:36px;font-family:Andale Mono, monospace">笔</div><div class="letter delay-5" style="font-size:36px;font-family:Andale Mono, monospace">记</div><br/></a></h1><p style="font-family:Andale Mono, monospace;margin-bottom:0;margin-top:10px;text-shadow:#FFF 1px 0 10px">May 30, 2019</p></div></div></header><div class="container"><div class="maincontent"><div class="blog-post-container"><div class="blog-post"><div class="blog-post-content"><p>webpack已经完全融入到了前端日常开发的方方面面，可以说现在的前端项目基本离不开webpack体系，因此了解webpack的实现原理对于日常开发会有很大的帮助。webpack已经不仅仅限于一款用于把node_modules中不同模块的代码与工程项目代码打包成块的工具，其意义在于整合编译项目中的不同资源，按需加载，它强大的可配置性赋予了项目极强的可延展性。</p>
<p>阅读webpack源码不可能像<code class="language-text">npm i webpack</code>一样简单，所以我觉得可以遵从一个很简单的逻辑主线来阅读，这个也是官方文档中所介绍的webpack运行的一般顺序：</p>
<p>入口 -> 路径解析 -> 单个文件 loaders -> chunk 操作 。</p>
<p>从这条主线出发，可以提出几个问题：
1、webpack是如何从入口文件出发，收集到工程下所有项目文件的？
2、loader的编译阶段发生在什么时候？发生了什么？
3、打包编译出的代码和配置文件的映射关系是什么？</p>
<p>但当你打开源码之后，你会发现webpack的所有主流程类都是继承自Tapable，一个基于事件钩子插件库，该库提供了多种事件触发类型的钩子。所以在读源码之前，必须先简要了解下，What is this Tapable Capable~</p>
<p>Tapable的构造方法：</p>
<ul>
<li>xxxHook(args: Array):Hook
args代表了一连串的变量名，返回了一个Hook实例，</li>
</ul>
<p>Hook实例的通用方法：</p>
<ul>
<li>tap(options: string|object, fn: Function)
向Hook中的taps数组中添加当前回调fn，添加方式取决于当前Hook的类型</li>
<li>call(...args)
同步钩子调用，args为xxxHook构造时，编译出的函数中传入的参数，这串参数会经历所有实例上带有的钩子。</li>
<li>callAsync(...args, callback)
异步钩子调用，args为xxxHook构造时，编译出的函数中传入的参数，这串参数会经历所有实例上带有的钩子。</li>
</ul>
<p>Tapable提供了同步及异步的钩子，同步的钩子包括</p>
<ul>
<li>SyncHook（同步顺序执行的钩子，钩子间的结果互不影响，出错时跳出）</li>
<li>SyncWaterfallHook（同步顺序执行，下一个钩子的接收参数是前一个钩子的返回，而非call时传入初始对象，出错时跳出）</li>
<li>SyncBailHook（同步顺序执行，前一个钩子出错或者没有返回，也就是调用了onError，之后的均不会被执行）</li>
<li>SyncLoopHook（同步顺序执行，如果一个钩子出错或者没有返回，就终止循环）</li>
</ul>
<p>异步钩子包括</p>
<ul>
<li>AsyncParallelHook （异步同时执行所有钩子，在每次运行回调时检查所有钩子是否执行完，执行完则抛出整体的回调）</li>
<li>AsyncParallelBailHook（异步同时执行所有钩子，在每次运行回调时检查所有钩子是否执行完，且检查执行是否有结果，没有结果则终止执行）</li>
<li>AsyncSeriesHook（异步顺序执行所有钩子，将所有钩子组成回调串，出错时跳出）</li>
<li>AsyncSeriesBailHook（异步顺序执行所有钩子，将所有钩子组成回调串，其中有个钩子没有返回值或者出错，则直接跳出）</li>
<li>AsyncSeriesWaterfallHook（异步顺序执行所有钩子，将所有钩子组成回调串，其中有个钩子没有返回值或者出错，则直接跳出，下一个钩子的接收参数是前一个钩子的返回，而非call时传入初始对象）x</li>
<li>AsyncSeriesLoopHook（异步顺序循环执行所有的钩子，出错或其中有个钩子的返回结果为undefined则跳出）</li>
</ul>
<p>另外还提供HookMap工具，这个返回相当于一个 Map&#x3C;key, value<xxxxHook>></p>
<ul>
<li>for(key).tap()</li>
<li>for(key).call()</li>
<li>for(key).callAsync()</li>
</ul>
<p>Compiler所继承的Tapable还有一些实现方法，包括Apply和Plugin，这两个方法是旧版webpack在Compiler上注册插件的方式。</p>
<p>还有拦截器 Intercept，Intercept会应用于绑定在该Hook实例上所有的钩子运行之前。其具有一个需要实现的属性函数register，register把钩子tap时整理好的<code class="language-text">options:{name:tap(name, fn), type: sync|async, context:Hook自带的运行环境, fn: tapFn}</code>带入然后返回处理好的options，webpack中多用作<strong>追踪</strong>和<strong>计算打包进程</strong></p>
<p>以上对于Tapable的了解应该是够用了。另外还有一些概念包括Plugin，Webpack中的Plugin是什么？它必须实现一个apply方法，该方法传入一个compiler对象，这个对象就好比构建compilation的架子，compilation相当于依赖图，Compiler继承了Tapable并且暴露了自己所有的生命周期，因此Plugin要做的就是在该compiler对象的生命周期中挂载自己的所需执行的方法，Plugin可以有自己的状态，并且在compiler对象处于不同阶段时改变自己的状态。举个里面简单的例子：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token string">"use strict"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> JsonParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./JsonParser"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> JsonGenerator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./JsonGenerator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">JsonModulesPlugin</span> <span class="token punctuation">{</span>
	<span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//  在 compilation 阶段注册 JsonModulesPlugin</span>
        <span class="token comment">//  compilation 钩子具有两个参数</span>
        <span class="token comment">//  /** @type {SyncHook&lt;Compilation, CompilationParams>} */</span>
        <span class="token comment">//  compilation: new SyncHook(["compilation", "params"]),</span>

		compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
			<span class="token string">"JsonModulesPlugin"</span><span class="token punctuation">,</span>
			<span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> <span class="token punctuation">{</span> normalModuleFactory <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token comment">// normalModuleFactory 是 NormalModuleFactory 的实例，用于把不同的文件读入，通过loaders转化成别的形式用于加入chunk中</span>
                <span class="token comment">// 这里是在 normalModuleFactory 构建解析器的阶段注入json的解析器</span>
                normalModuleFactory<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>createParser
					<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">"JsonModulesPlugin"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
						<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JsonParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 这里是在 normalModuleFactory 构建生成器的阶段注入json的生成器</span>
				normalModuleFactory<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>createGenerator
					<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">"JsonModulesPlugin"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
						<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JsonGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> JsonModulesPlugin<span class="token punctuation">;</span></code></pre></div>
<p>下面可以着手来dive into webpack源码了。</p>
<p>首先来回答第一个问题，webpack在运行时，我们通常会执行一个函数<code class="language-text">webpack(options)</code>，在就是读入webpack.config.js中的配置，然后返回一个<code class="language-text">Compile</code>对象，然后运行这个对象的run()。run()在准备好一些文件缓存、计时器之类的之后，执行compile方法开始编译，complile方法的目的在于构建Compilation对象，该对象贯穿于整个打包周期中。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">    <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 构建新的 Compulation 所需的参数</span>
		<span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newCompilationParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeCompile<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 这里从webpack.config.js中读取了配置，并为 compilation 装配了用于解析 dependancies 所需要的 compilation.dependencyFactories 下</span>
			<span class="token keyword">const</span> compilation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">newCompilation</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 完成了所有的准备，此时开始 Compilation 阶段，就是真正的从入口处开始打包</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token comment">// 以下可以先不关心，不在第一个问题的范围之内</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

				compilation<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

					compilation<span class="token punctuation">.</span><span class="token function">seal</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

						<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterCompile<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

							<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> compilation<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span></code></pre></div>
<p>Compilation从入口，也就是我们通常写的webpack.config.js的entry属性开始读取文件，在读取文件内容之前，webpack必须确认文件的存在，如果不存在，就会出现webpack的日常报错 Module not found，为啥是Module node found呢？因为在webpack中，Module的概念相当于就是单个引用文件，接下来回到正题。</p>
<p>这里就会使用到了<a href="https://github.com/webpack/enhanced-resolve">enhance-resolver</a>这个库，这个库会去寻找工程中的依赖位置，可能是项目目录下，也可能是node_modules中，也可能是alias中等，然后将文件的stats信息，绝对路径，以及这次解析的独立ID（重复的路径可以复用）。举个常见的栗子，单入口的SingleEntryPlugin中：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span><span class="token punctuation">.</span>
        <span class="token comment">// 这里接上一个代码块的 this.hooks.make.callAsync 调用</span>
		compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span>
			<span class="token string">"SingleEntryPlugin"</span><span class="token punctuation">,</span>
			<span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
				<span class="token keyword">debugger</span><span class="token punctuation">;</span>
				<span class="token keyword">const</span> <span class="token punctuation">{</span> entry<span class="token punctuation">,</span> name<span class="token punctuation">,</span> context <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

                <span class="token keyword">const</span> dep <span class="token operator">=</span> SingleEntryPlugin<span class="token punctuation">.</span><span class="token function">createDependency</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 此处启动 compilation 的主流程， addEntry 中会开始构建 Module 的 主流程</span>
				compilation<span class="token punctuation">.</span><span class="token function">addEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> dep<span class="token punctuation">,</span> name<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span></code></pre></div>
<p>compilation的主流程是一个不断递归的过程，首先从entry出发，通过ModuleFactory创建一个Module(moduleFactory.create)，ModuleFactory的类型是在Resolve阶段就决定好了的。举个栗子，比如<a href="https://github.com/webpack/webpack/blob/master/lib/NormalModuleFactory.js//#L369">NormalModuleFactory</a></p>
<p>CODE 1</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// addEntry 会调用到 ModuleFactory.create 方法创建Module</span>
<span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token operator">...</span>
    <span class="token comment">// Resolve前的准备，只是把</span>
        <span class="token comment">//   {</span>
        <span class="token comment">//     contextInfo,</span>
        <span class="token comment">//     resolveOptions,</span>
        <span class="token comment">//     context,</span>
        <span class="token comment">//     request,</span>
        <span class="token comment">//     dependencies</span>
        <span class="token comment">//   }</span>
        <span class="token comment">//   做了一些处理返回到回调的result当中去</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeResolve<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
            contextInfo<span class="token punctuation">,</span>
            resolveOptions<span class="token punctuation">,</span>
            context<span class="token punctuation">,</span>
            request<span class="token punctuation">,</span>
            dependencies
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 这个hook执行之后，返回的一个factory(data, callback)函数，其执行顺序与tap进的顺序相反（SyncWaterfallHook）</span>
            <span class="token comment">// 用于构建并执行factory</span>
            <span class="token keyword">const</span> factory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">factory</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>factory<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 执行返回的 factory(data, callback)函数</span>
            <span class="token function">factory</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 对这次的解析结果做了缓存，缓存的是module与dependency的对应关系</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>module <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cachePredicate</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> d <span class="token keyword">of</span> dependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        dependencyCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>factory<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">"NormalModuleFactory"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token parameter">result<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里就是上面 this.hooks.factory.call(null) 真正执行的函数，result 对应了上面 传入的处理过的 result</span>

        <span class="token comment">// 这个hook执行与之前的factory使用了同样的构建方式，返回的一个resolver(data, callback)函数，其执行顺序与tap进的顺序相反（SyncWaterfallHook）</span>
        <span class="token comment">// 用于构建 resolver 函数</span>
        <span class="token keyword">let</span> resolver <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">resolver</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resolver<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 执行 resolver</span>
        <span class="token comment">// 这步的作用主要是收集可以解析这个文件所需loaders，及配置这些loader</span>
        <span class="token function">resolver</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>data<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> data<span class="token punctuation">.</span>source <span class="token operator">===</span> <span class="token string">"function"</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 这有点像 koa 的洋葱圈 先执行完 afterResolve 之后又会跳回 factory 的回调之中</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterResolve<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">let</span> createdModule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">createModule</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>createdModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Empty dependency (no request)"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    createdModule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NormalModule</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                createdModule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">module</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>createdModule<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 现在构建这个 Module 的方法准备好了，回到工厂可以准备出厂了</span>
                <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> createdModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Module创建后就会被构建，CODE 1的回调回到 compilation 的 _addModuleChain 函数，在做了一些处理后执行 buildModule 主方法，从而开始构建这个module，module在含义上其实就是工程内打包的不同文件。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">    <span class="token function">buildModule</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> optional<span class="token punctuation">,</span> origin<span class="token punctuation">,</span> dependencies<span class="token punctuation">,</span> thisCallback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
        <span class="token comment">// 绑定 sourcemap, progress 到该module的生命周期</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// module构建住方法 这里可以代入 NormalModule 来看</span>
        module<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span>
			<span class="token keyword">this</span><span class="token punctuation">,</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>resolverFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"normal"</span><span class="token punctuation">,</span> module<span class="token punctuation">.</span>resolveOptions<span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>inputFileSystem<span class="token punctuation">,</span>
			<span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token operator">...</span>

                <span class="token keyword">const</span> originalMap <span class="token operator">=</span> module<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">map<span class="token punctuation">,</span> v<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
					map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> map<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 依赖的对应表排序</span>
				module<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
					<span class="token keyword">const</span> cmp <span class="token operator">=</span> <span class="token function">compareLocations</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>loc<span class="token punctuation">,</span> b<span class="token punctuation">.</span>loc<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>cmp<span class="token punctuation">)</span> <span class="token keyword">return</span> cmp<span class="token punctuation">;</span>
					<span class="token keyword">return</span> originalMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">-</span> originalMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span></code></pre></div>
<p>NormalModule在运行build方法的时候会先跑一遍loader（这是在之前loader resolver的时候就绑定好的），</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">    <span class="token function">doBuild</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> compilation<span class="token punctuation">,</span> resolver<span class="token punctuation">,</span> fs<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> loaderContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createLoaderContext</span><span class="token punctuation">(</span>
			resolver<span class="token punctuation">,</span>
			options<span class="token punctuation">,</span>
			compilation<span class="token punctuation">,</span>
			fs
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// loader-runner https://github.com/webpack/loader-runner/blob/master/lib/LoaderRunner.js#L251</span>
        <span class="token comment">// 这里回答了第二个问题</span>
		<span class="token function">runLoaders</span><span class="token punctuation">(</span>
			<span class="token punctuation">{</span>
				resource<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resource<span class="token punctuation">,</span>
				loaders<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loaders<span class="token punctuation">,</span>
				context<span class="token punctuation">:</span> loaderContext<span class="token punctuation">,</span>
				readResource<span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token comment">// err: 是否出错</span>
                <span class="token comment">// result.result: Buffer | String</span>
                <span class="token comment">// The result</span>

                <span class="token comment">// result.resourceBuffer: Buffer</span>
                <span class="token comment">// 源文件读入后生成的 Buffer (useful for SourceMaps)</span>

                <span class="token comment">// result.cacheable: Bool</span>
                <span class="token comment">// 这个可以缓存还是需要执行</span>

                <span class="token comment">// result.fileDependencies: String[]</span>
                <span class="token comment">// 这个结果是由哪些文件组成的</span>

                <span class="token comment">// result.contextDependencies: String[]</span>
                <span class="token comment">// 这个结果是由哪些文件目录组成的</span>
                <span class="token operator">...</span>
                <span class="token comment">// 把结果存到当前 Module 当中</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>_source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createSource</span><span class="token punctuation">(</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>binary <span class="token operator">?</span> <span class="token function">asBuffer</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">asString</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">,</span>
					resourceBuffer<span class="token punctuation">,</span>
					sourceMap
				<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>_ast <span class="token operator">=</span>
					<span class="token keyword">typeof</span> extraInfo <span class="token operator">===</span> <span class="token string">"object"</span> <span class="token operator">&amp;&amp;</span>
					extraInfo <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
					extraInfo<span class="token punctuation">.</span>webpackAST <span class="token operator">!==</span> <span class="token keyword">undefined</span>
						<span class="token operator">?</span> extraInfo<span class="token punctuation">.</span>webpackAST
						<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span></code></pre></div>
<p>然后将处理完的结果放入parser中解析。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">    <span class="token comment">// 这里的build 对应了向前第二个代码块的 module.build(</span>
    <span class="token function">build</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> compilation<span class="token punctuation">,</span> resolver<span class="token punctuation">,</span> fs<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
        <span class="token comment">// doBuild 对应了上一个代码块</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doBuild</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> compilation<span class="token punctuation">,</span> resolver<span class="token punctuation">,</span> fs<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
			<span class="token operator">...</span>
			<span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 解析该文件内容</span>
				<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>_ast <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_source<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token punctuation">{</span>
						current<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
						module<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
						compilation<span class="token punctuation">:</span> compilation<span class="token punctuation">,</span>
						options<span class="token punctuation">:</span> options
					<span class="token punctuation">}</span><span class="token punctuation">,</span>
					<span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token function">handleParseError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
							<span class="token function">handleParseResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// 返回</span>
					<span class="token function">handleParseResult</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">handleParseError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span></code></pre></div>
<p>在解析的过程中把文件中用到的import之类的信息解析出来，把引入的文件找到并匹配对应的Dependency放入Module当中</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Parser.js</span>
    <span class="token function">parse</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> initialState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token operator">...</span>
        ast <span class="token operator">=</span> Parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            sourceType<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sourceType<span class="token punctuation">,</span>
            onComment<span class="token punctuation">:</span> comments
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token operator">...</span>
        <span class="token comment">// 解析整个文件的声明句，解析出一个通过钩子抛出，钩子将其加入到 该 Module 的 dependancis 当中</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walkStatements</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span></code></pre></div>
<p>解析完之后回到 Compilation，根据这次的解析结果决定是否要继续继续解析该 Module 的依赖</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">    moduleFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
            contextInfo<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                issuer<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
                compiler<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>name
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            context<span class="token punctuation">:</span> context<span class="token punctuation">,</span>
            dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span>dependency<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>

            <span class="token keyword">const</span> <span class="token function-variable function">afterBuild</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>currentProfile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> afterBuilding <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    currentProfile<span class="token punctuation">.</span>building <span class="token operator">=</span> afterBuilding <span class="token operator">-</span> afterFactory<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 如果当前加入的 Module 中具有依赖，则继续解析这个 Module 中的所有依赖，也就是回到了单个 Module 的resolve阶段，</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>addModuleResult<span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processModuleDependencies</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token operator">...</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>addModuleResult<span class="token punctuation">.</span>build<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                    <span class="token operator">...</span>

                    <span class="token function">afterBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               <span class="token operator">...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>这基本上回答了第一个问题，在所有的 Module 解析完毕之后，this.hooks.make走到了回调函数。</p>
<p>接下来，来回答第三个问题，第三个问题涉及到chunk，还是这段 Compile 的 compile 函数，现在运行到seal阶段</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">    <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>make<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 这里所有的 module 都生成好了，执行了 finishModules 钩子</span>
                <span class="token comment">// webpack本身这里重新整理了一些exports，比如把 export * from '.../'</span>
                <span class="token comment">//另外还有 webAssembly module 之类的不在本篇讨论范围之内，有兴趣可以自己研究</span>
				compilation<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 这边进入打成 chunk 的主流程</span>
					compilation<span class="token punctuation">.</span><span class="token function">seal</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

						<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterCompile<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

							<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> compilation<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span></code></pre></div>
<p>下面来看seal方法</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">    <span class="token function">seal</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里 webpack 检查了一下所有 module 的绝对路径是否存在只是大小写区分。若存在会抛出 CaseSensitiveModulesWarning</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">seal</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">while</span> <span class="token punctuation">(</span>
            <span class="token comment">// 这里的写法相当于</span>
            <span class="token comment">/**
             * if(this.hooks.optimizeDependenciesBasic.call(this.modules))
             *   if(this.hooks.optimizeDependencies.call(this.modules))
             *      if(this.hooks.optimizeDependenciesAdvanced.call(this.modules)) { }
             **/</span>
            <span class="token comment">// 这些都是 SyncBailHook</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">optimizeDependenciesBasic</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token comment">// production mode下会启用的 FlagDependencyUsagePlugin SideEffectsFlagPlugin 在这里调用</span>
            <span class="token comment">// 如果要disable这个plugin可以在 optimizeDependenciesBasic 返回一个非undefined的值</span>
            <span class="token comment">// FlagDependencyUsagePlugin 应该是能够将 module 中 exports 的有效部分标记出来</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">optimizeDependencies</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">)</span> <span class="token operator">||</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">optimizeDependenciesAdvanced</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">)</span>
		<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">/* empty */</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterOptimizeDependencies</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">beforeChunks</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 到此为止开始真正的合并chunk的过程</span>
        <span class="token comment">// 按 webpack.config.js 中设置的 entry 打 chunk</span>
        <span class="token comment">// 并加入到 chunkGroups</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> preparedEntrypoint <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_preparedEntrypoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> module <span class="token operator">=</span> preparedEntrypoint<span class="token punctuation">.</span>module<span class="token punctuation">;</span>
            <span class="token keyword">const</span> name <span class="token operator">=</span> preparedEntrypoint<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
            <span class="token comment">// 如果有一致的 chunk 名则复用</span>
			<span class="token keyword">const</span> chunk <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addChunk</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">const</span> entrypoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entrypoint</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
			entrypoint<span class="token punctuation">.</span><span class="token function">setRuntimeChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
			entrypoint<span class="token punctuation">.</span><span class="token function">addOrigin</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> preparedEntrypoint<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>namedChunkGroups<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> entrypoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>entrypoints<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> entrypoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>chunkGroups<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>entrypoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// entrypoint 和 chunk 建立多对多的关系</span>
            GraphHelpers<span class="token punctuation">.</span><span class="token function">connectChunkGroupAndChunk</span><span class="token punctuation">(</span>entrypoint<span class="token punctuation">,</span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// chunk 和 module 建立多对多的关系</span>
			GraphHelpers<span class="token punctuation">.</span><span class="token function">connectChunkAndModule</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>

			chunk<span class="token punctuation">.</span>entryModule <span class="token operator">=</span> module<span class="token punctuation">;</span>
			chunk<span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>

			<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">assignDepth</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 生成 chunk图，</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processDependenciesBlocksForChunkGroups</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunkGroups<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token operator">...</span>
	<span class="token punctuation">}</span></code></pre></div>
<p>这里可以来研究下生成 chunk 图的方法。chunk图是个什么东西呢？chunk图其实建立在module图上，module图就是表示module之间的依赖关系，可能是同步依赖，也可能是异步依赖，这样在异步依赖的时候需对chunk分组来描述chunk之间的依赖关系，因此算法先生成了简单的module图，然后在这基础上做了两步chunk图的计算，下面简单分析下chunk图的生成方法。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token function">processDependenciesBlocksForChunkGroups</span><span class="token punctuation">(</span><span class="token parameter">inputChunkGroups</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> chunkDependencies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> allCreatedChunkGroups <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> blockInfoMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 存放 module 图</span>

		<span class="token keyword">const</span> <span class="token function-variable function">iteratorDependency</span> <span class="token operator">=</span> <span class="token parameter">d</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
			<span class="token comment">// We skip Dependencies without Reference</span>
			<span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDependencyReference</span><span class="token punctuation">(</span>currentModule<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ref<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// We skip Dependencies without Module pointer</span>
			<span class="token keyword">const</span> refModule <span class="token operator">=</span> ref<span class="token punctuation">.</span>module<span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>refModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// We skip weak Dependencies</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ref<span class="token punctuation">.</span>weak<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			blockInfoModules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>refModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> <span class="token function-variable function">iteratorBlockPrepare</span> <span class="token operator">=</span> <span class="token parameter">b</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
			blockInfoBlocks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
			blockQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>

		<span class="token comment">/** @type {Module} */</span>
		<span class="token keyword">let</span> currentModule<span class="token punctuation">;</span>
		<span class="token comment">/** @type {DependenciesBlock} */</span>
		<span class="token keyword">let</span> block<span class="token punctuation">;</span>
		<span class="token comment">/** @type {DependenciesBlock[]} */</span>
		<span class="token keyword">let</span> blockQueue<span class="token punctuation">;</span>
		<span class="token comment">/** @type {Set&lt;Module>} */</span>
		<span class="token keyword">let</span> blockInfoModules<span class="token punctuation">;</span> <span class="token comment">// 存放同步加载的module</span>
		<span class="token comment">/** @type {AsyncDependenciesBlock[]} */</span>
		<span class="token keyword">let</span> blockInfoBlocks<span class="token punctuation">;</span>  <span class="token comment">// 存放异步加载的module</span>

		<span class="token comment">// 整个是为了生成简单的 mudule 图</span>
		<span class="token comment">/**
		 * 每个 module 都有两个分支，
		 * blocks: 存异步 module，
		 * modules: 存同步 module,
		 *
		 * blockInfoMap 用 module 做键值，构建module的属性依赖结构
		 * 类似这样
		 *                   A
		 *                 /  \
		 *	modules -> [B, C] [D]  &lt;- blocks(异步)
		 *             /      /
		 * modules-> [E]    [F]  &lt;- modules
		 *
		 **/</span>

		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> module <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			blockQueue <span class="token operator">=</span> <span class="token punctuation">[</span>module<span class="token punctuation">]</span><span class="token punctuation">;</span>
			currentModule <span class="token operator">=</span> module<span class="token punctuation">;</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span>blockQueue<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				block <span class="token operator">=</span> blockQueue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				blockInfoModules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				blockInfoBlocks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">.</span>variables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token function">iterationBlockVariable</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>variables<span class="token punctuation">,</span> iteratorDependency<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// 普通模块加入 blockInfoModules 中</span>
					<span class="token function">iterationOfArrayCallback</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>dependencies<span class="token punctuation">,</span> iteratorDependency<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">.</span>blocks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// 异步模块加入 blockInfoBlocks 中</span>
					<span class="token function">iterationOfArrayCallback</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>blocks<span class="token punctuation">,</span> iteratorBlockPrepare<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">const</span> blockInfo <span class="token operator">=</span> <span class="token punctuation">{</span>
					modules<span class="token punctuation">:</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>blockInfoModules<span class="token punctuation">)</span><span class="token punctuation">,</span>
					blocks<span class="token punctuation">:</span> blockInfoBlocks
				<span class="token punctuation">}</span><span class="token punctuation">;</span>
				<span class="token comment">// 当前 module 加入 module图中</span>
				blockInfoMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> blockInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// PART1 开始分割简单的 chunk 图</span>
		<span class="token comment">/** @type {Map&lt;ChunkGroup, { index: number, index2: number }>} */</span>

		<span class="token keyword">const</span> chunkGroupCounters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> chunkGroup <span class="token keyword">of</span> inputChunkGroups<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			chunkGroupCounters<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>chunkGroup<span class="token punctuation">,</span> <span class="token punctuation">{</span> index<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> index2<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">let</span> nextFreeModuleIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">let</span> nextFreeModuleIndex2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

		<span class="token comment">/** @type {Map&lt;DependenciesBlock, ChunkGroup>} */</span>
		<span class="token keyword">const</span> blockChunkGroups <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">/** @type {Set&lt;DependenciesBlock>} */</span>
		<span class="token keyword">const</span> blocksWithNestedBlocks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> <span class="token constant">ADD_AND_ENTER_MODULE</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> <span class="token constant">ENTER_MODULE</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> <span class="token constant">PROCESS_BLOCK</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> <span class="token constant">LEAVE_MODULE</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

		<span class="token comment">/**
		 * @typedef {Object} QueueItem
		 * @property {number} action
		 * @property {DependenciesBlock} block
		 * @property {Module} module
		 * @property {Chunk} chunk
		 * @property {ChunkGroup} chunkGroup
		 */</span>

		<span class="token comment">/**
		 * @param {ChunkGroup} chunkGroup chunk group
		 * @returns {QueueItem} queue item
		 */</span>
		<span class="token keyword">const</span> <span class="token function-variable function">chunkGroupToQueueItem</span> <span class="token operator">=</span> <span class="token parameter">chunkGroup</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
			action<span class="token punctuation">:</span> <span class="token constant">ENTER_MODULE</span><span class="token punctuation">,</span>
			block<span class="token punctuation">:</span> chunkGroup<span class="token punctuation">.</span>chunks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>entryModule<span class="token punctuation">,</span>
			module<span class="token punctuation">:</span> chunkGroup<span class="token punctuation">.</span>chunks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>entryModule<span class="token punctuation">,</span>
			chunk<span class="token punctuation">:</span> chunkGroup<span class="token punctuation">.</span>chunks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
			chunkGroup
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Start with the provided modules/chunks</span>
		<span class="token comment">/** @type {QueueItem[]} */</span>
		<span class="token keyword">let</span> queue <span class="token operator">=</span> inputChunkGroups<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>chunkGroupToQueueItem<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/** @type {QueueItem[]} */</span>
		<span class="token keyword">let</span> queueDelayed <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token comment">/** @type {Module} */</span>
		<span class="token keyword">let</span> module<span class="token punctuation">;</span>
		<span class="token comment">/** @type {Chunk} */</span>
		<span class="token keyword">let</span> chunk<span class="token punctuation">;</span>
		<span class="token comment">/** @type {ChunkGroup} */</span>
		<span class="token keyword">let</span> chunkGroup<span class="token punctuation">;</span>

		<span class="token comment">// For each async Block in graph</span>
		<span class="token comment">/**
		 * @param {AsyncDependenciesBlock} b iterating over each Async DepBlock
		 * @returns {void}
		 */</span>
		<span class="token keyword">const</span> <span class="token function-variable function">iteratorBlock</span> <span class="token operator">=</span> <span class="token parameter">b</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
			<span class="token comment">// 1. We create a chunk for this Block</span>
			<span class="token comment">// but only once (blockChunkGroups map)</span>
			<span class="token comment">// 如果 blockChunkGroups 中不存在这个module所属的chunk，为这个异步的 module 创建一个</span>
			<span class="token keyword">let</span> c <span class="token operator">=</span> blockChunkGroups<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				c <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>namedChunkGroups<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>chunkName<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span><span class="token function">isInitial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
						<span class="token keyword">new</span> <span class="token class-name">AsyncDependencyToInitialChunkError</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>chunkName<span class="token punctuation">,</span> module<span class="token punctuation">,</span> b<span class="token punctuation">.</span>loc<span class="token punctuation">)</span>
					<span class="token punctuation">)</span><span class="token punctuation">;</span>
					c <span class="token operator">=</span> chunkGroup<span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					c <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addChunkInGroup</span><span class="token punctuation">(</span>
						b<span class="token punctuation">.</span>groupOptions <span class="token operator">||</span> b<span class="token punctuation">.</span>chunkName<span class="token punctuation">,</span>
						module<span class="token punctuation">,</span>
						b<span class="token punctuation">.</span>loc<span class="token punctuation">,</span>
						b<span class="token punctuation">.</span>request
					<span class="token punctuation">)</span><span class="token punctuation">;</span>
					chunkGroupCounters<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token punctuation">{</span> index<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> index2<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					blockChunkGroups<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
					allCreatedChunkGroups<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">// TODO webpack 5 remove addOptions check</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">.</span>addOptions<span class="token punctuation">)</span> c<span class="token punctuation">.</span><span class="token function">addOptions</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>groupOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
				c<span class="token punctuation">.</span><span class="token function">addOrigin</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> b<span class="token punctuation">.</span>loc<span class="token punctuation">,</span> b<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// 2. We store the Block+Chunk mapping as dependency for the chunk</span>
			<span class="token comment">// chunkDependencies 就是这个 chunkGroup 所依赖的其他chunk</span>
			<span class="token keyword">let</span> deps <span class="token operator">=</span> chunkDependencies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>chunkGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">)</span> chunkDependencies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>chunkGroup<span class="token punctuation">,</span> <span class="token punctuation">(</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				block<span class="token punctuation">:</span> b<span class="token punctuation">,</span>
				chunkGroup<span class="token punctuation">:</span> c<span class="token punctuation">,</span>
				couldBeFiltered<span class="token punctuation">:</span> <span class="token boolean">true</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// 3. We enqueue the DependenciesBlock for traversal</span>
			<span class="token comment">// 异步的模块放到同步模块走完再循环</span>
			queueDelayed<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
				action<span class="token punctuation">:</span> <span class="token constant">PROCESS_BLOCK</span><span class="token punctuation">,</span>
				block<span class="token punctuation">:</span> b<span class="token punctuation">,</span>
				module<span class="token punctuation">:</span> module<span class="token punctuation">,</span>
				chunk<span class="token punctuation">:</span> c<span class="token punctuation">.</span>chunks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
				chunkGroup<span class="token punctuation">:</span> c
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>

		<span class="token comment">// Iterative traversal of the Module graph</span>
		<span class="token comment">// Recursive would be simpler to write but could result in Stack Overflows</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// 递归变循环的方法是构造一个栈来代替调用栈</span>
				<span class="token keyword">const</span> queueItem <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				module <span class="token operator">=</span> queueItem<span class="token punctuation">.</span>module<span class="token punctuation">;</span>
				block <span class="token operator">=</span> queueItem<span class="token punctuation">.</span>block<span class="token punctuation">;</span>
				chunk <span class="token operator">=</span> queueItem<span class="token punctuation">.</span>chunk<span class="token punctuation">;</span>
				chunkGroup <span class="token operator">=</span> queueItem<span class="token punctuation">.</span>chunkGroup<span class="token punctuation">;</span>

				<span class="token keyword">switch</span> <span class="token punctuation">(</span>queueItem<span class="token punctuation">.</span>action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">case</span> <span class="token constant">ADD_AND_ENTER_MODULE</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
						<span class="token comment">// We connect Module and Chunk when not already done</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">addModule</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							module<span class="token punctuation">.</span><span class="token function">addChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
							<span class="token comment">// already connected, skip it</span>
							<span class="token keyword">break</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
					<span class="token comment">// fallthrough</span>
					<span class="token keyword">case</span> <span class="token constant">ENTER_MODULE</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
						<span class="token comment">// 从 entry 进入</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>chunkGroup <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token comment">// 入栈的时候带上 index</span>
							<span class="token keyword">const</span> index <span class="token operator">=</span> chunkGroup<span class="token punctuation">.</span><span class="token function">getModuleIndex</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
								chunkGroup<span class="token punctuation">.</span><span class="token function">setModuleIndex</span><span class="token punctuation">(</span>
									module<span class="token punctuation">,</span>
									chunkGroupCounters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>chunkGroup<span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token operator">++</span>
								<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span>

						<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>index <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							module<span class="token punctuation">.</span>index <span class="token operator">=</span> nextFreeModuleIndex<span class="token operator">++</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token comment">// 将退出队列的操作推入栈中</span>
						queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
							action<span class="token punctuation">:</span> <span class="token constant">LEAVE_MODULE</span><span class="token punctuation">,</span>
							block<span class="token punctuation">,</span>
							module<span class="token punctuation">,</span>
							chunk<span class="token punctuation">,</span>
							chunkGroup
						<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token comment">// 直接进入对子module的遍历</span>
					<span class="token comment">// fallthrough</span>
					<span class="token keyword">case</span> <span class="token constant">PROCESS_BLOCK</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
						<span class="token comment">// get prepared block info</span>
						<span class="token keyword">const</span> blockInfo <span class="token operator">=</span> blockInfoMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>

						<span class="token comment">// Traverse all referenced modules</span>
						<span class="token comment">// 处理所有的同步module引用</span>
						<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> blockInfo<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token keyword">const</span> refModule <span class="token operator">=</span> blockInfo<span class="token punctuation">.</span>modules<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">containsModule</span><span class="token punctuation">(</span>refModule<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
								<span class="token comment">// skip early if already connected</span>
								<span class="token keyword">continue</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
							<span class="token comment">// enqueue the add and enter to enter in the correct order</span>
							<span class="token comment">// this is relevant with circular dependencies</span>
							<span class="token comment">// 把所有的同步依赖 module 压入栈中处理</span>
							queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
								action<span class="token punctuation">:</span> <span class="token constant">ADD_AND_ENTER_MODULE</span><span class="token punctuation">,</span>
								block<span class="token punctuation">:</span> refModule<span class="token punctuation">,</span>
								module<span class="token punctuation">:</span> refModule<span class="token punctuation">,</span>
								chunk<span class="token punctuation">,</span>
								chunkGroup
							<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>

						<span class="token comment">// Traverse all Blocks</span>
						<span class="token comment">// 再处理异步依赖module 到前面的 iteratorBlock 方法</span>
						<span class="token function">iterationOfArrayCallback</span><span class="token punctuation">(</span>blockInfo<span class="token punctuation">.</span>blocks<span class="token punctuation">,</span> iteratorBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>

						<span class="token keyword">if</span> <span class="token punctuation">(</span>blockInfo<span class="token punctuation">.</span>blocks<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> module <span class="token operator">!==</span> block<span class="token punctuation">)</span> <span class="token punctuation">{</span>
							blocksWithNestedBlocks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">break</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">case</span> <span class="token constant">LEAVE_MODULE</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
						<span class="token comment">// 在出栈的时候带上 index2</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>chunkGroup <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							<span class="token keyword">const</span> index <span class="token operator">=</span> chunkGroup<span class="token punctuation">.</span><span class="token function">getModuleIndex2</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
								chunkGroup<span class="token punctuation">.</span><span class="token function">setModuleIndex2</span><span class="token punctuation">(</span>
									module<span class="token punctuation">,</span>
									chunkGroupCounters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>chunkGroup<span class="token punctuation">)</span><span class="token punctuation">.</span>index2<span class="token operator">++</span>
								<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span>

						<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>index2 <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
							module<span class="token punctuation">.</span>index2 <span class="token operator">=</span> nextFreeModuleIndex2<span class="token operator">++</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
						<span class="token keyword">break</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 外层循环是为了遍历异步依赖的 module</span>
			<span class="token keyword">const</span> tempQueue <span class="token operator">=</span> queue<span class="token punctuation">;</span>
			queue <span class="token operator">=</span> queueDelayed<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			queueDelayed <span class="token operator">=</span> tempQueue<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// PART TWO</span>
		<span class="token comment">// PART2 主要是针对第一步生成chunk图做了一些优化处理，有兴趣可以自行阅读，chunk分离的结果对应了最终输出的文件夹下的不同chunk文件</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span></code></pre></div>
<p>还是回到第三个问题，现在我们把这个问题定位到了一个个的chunk当中，那么chunk中的代码是怎么和你平时写的那些代码对应起来的呢，可能你读到这里已经有了答案，不过，还有一些细节性的问题可以仔细的研究一下。接着来看seal方法。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token function">seal</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processDependenciesBlocksForChunkGroups</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunkGroups<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">...</span>
	<span class="token operator">...</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>optimizeTree<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
		<span class="token operator">...</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createModuleAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取到 module 下的 assets，比如图片之类的</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">shouldGenerateChunkAssets</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">beforeChunkAssets</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createChunkAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 套用不同模板针对chunk下的 files 生成整个chunk的source代码，主要是生成 chunk.files</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">additionalChunkAssets</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">summarizeDependencies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>shouldRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>records<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>additionalAssets<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 很多插件会对 chunk.files 做最终处理的钩子</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>optimizeChunkAssets<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// 内置的 sourcemap-dev-plugin</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterOptimizeChunkAssets</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>optimizeAssets<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">afterOptimizeAssets</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>assets<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">needAdditionalSeal</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">unseal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">seal</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					<span class="token comment">// 整个打chunk的流程走完</span>
					<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterSeal<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span></code></pre></div>
<p>到这里整个webpack打包的主流程走完，接下来会将打好的包输出到目标文件目录下，现在回到Compiler.js中</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">		<span class="token keyword">const</span> <span class="token function-variable function">onCompiled</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">shouldEmit</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stats</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">;</span>
				stats<span class="token punctuation">.</span>startTime <span class="token operator">=</span> startTime<span class="token punctuation">;</span>
				stats<span class="token punctuation">.</span>endTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>stats<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> stvats<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// 此处输出文件到文件目录</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitAssets</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span>compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">needAdditionalPass</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					compilation<span class="token punctuation">.</span>needAdditionalPass <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

					<span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stats</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">;</span>
					stats<span class="token punctuation">.</span>startTime <span class="token operator">=</span> startTime<span class="token punctuation">;</span>
					stats<span class="token punctuation">.</span>endTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>stats<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

						<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>additionalPass<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
							<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>onCompiled<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitRecords</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>

					<span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stats</span><span class="token punctuation">(</span>compilation<span class="token punctuation">)</span><span class="token punctuation">;</span>
					stats<span class="token punctuation">.</span>startTime <span class="token operator">=</span> startTime<span class="token punctuation">;</span>
					stats<span class="token punctuation">.</span>endTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">callAsync</span><span class="token punctuation">(</span>stats<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">return</span> <span class="token function">finalCallback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> stats<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>这基本上是回答了第三个问题，打包出的文件按不同chunk输出文件，chunk中的module按引用顺序深度排列，具体写法依赖与模板套用的语法。</p>
<h2>总结</h2>
<p>到这里为止，我们基本梳理了一遍webpack的主流程，从入口到最后打包成文件。Compilation作为一条主线贯穿了整个webpack的生命周期之中，若要细抠每个流程的细节可以从Compilation中属性入手，了解每个属性的作用及在各个生命周期中的状态。Tapable给予了webpack强大的可配置性，结合Compilation可以发现，这是一个生产单一对象的过程，面向过程webpack通过Tapable开了多个不同的切面，切面可能具有自己游离的对象，贯穿于Compilation不同的生命周期之中，最终都是为了能够赋予chunks独特的特性。有了这条主线之后，无论对于之后开发webpack的插件，还是继续深挖webpack源码都具有指导意义。</p></div></div></div></div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-template-blog-template-js","jsonName":"webpack-note-0d1","path":"/webpack-note"};window.dataPath="964/path---webpack-note-0-d-1-504-2l9gdkNmgb2VUQV7d4FzHJIydiY";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-10d8601ec8ddaba350d4.js"],"component---src-template-blog-template-js":["/component---src-template-blog-template-js-33d564d6a33c6a5966d5.js"],"component---src-pages-404-js":["/component---src-pages-404-js-0b30e833deebdb5dd07d.js"],"component---src-pages-index-js":["/component---src-pages-index-js-2583d5c554da72a5a5e1.js"],"pages-manifest":["/pages-manifest-b02bbed45ee247c27baf.js"]};/*]]>*/</script><script src="/webpack-runtime-4b53265e0c6f6db20aa5.js" async=""></script><script src="/styles-a37a2e6ccdfe373f027f.js" async=""></script><script src="/component---src-template-blog-template-js-33d564d6a33c6a5966d5.js" async=""></script><script src="/app-10d8601ec8ddaba350d4.js" async=""></script></body></html>